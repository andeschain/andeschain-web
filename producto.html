<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha de Origen Digital | AndesChain</title>
    <link rel="icon" type="image/png" href="assets/favicon.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;800&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'corp': { 50: '#F0FDF4', 100: '#DCFCE7', 500: '#10B981', 600: '#059669', 900: '#064E3B' },
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'], display: ['Outfit', 'sans-serif'] },
                }
            }
        }
    </script>

    <style>
        body { background-color: #FAFAFA; color: #1E293B; -webkit-font-smoothing: antialiased; }
        .glass-card { background: white; border-radius: 32px; border: 1px solid #F1F5F9; overflow: hidden; }
        .timeline-line { position: absolute; left: 24px; top: 20px; bottom: 0; width: 2px; background: #E2E8F0; z-index: 0; }
        .timeline-item { position: relative; z-index: 10; padding-left: 60px; padding-bottom: 40px; }
        .timeline-dot { position: absolute; left: 16px; top: 0; width: 18px; height: 18px; border-radius: 50%; background: #10B981; border: 4px solid white; box-shadow: 0 0 0 1px #E2E8F0; }
        
        .map-bg {
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/e/ec/Paine_chile.jpg'); /* Placeholder genérico */
            background-size: cover; background-position: center;
        }
    </style>
</head>
<body class="pb-20">

    <nav class="fixed w-full bg-white/90 backdrop-blur-md border-b border-gray-100 py-3 px-6 z-50 flex justify-between items-center">
        <a href="index.html" class="flex items-center gap-2">
            <img src="assets/favicon.png" class="h-6">
            <span class="font-display font-bold text-sm uppercase tracking-tight text-slate-900">AndesChain</span>
        </a>
        <div class="flex items-center gap-2 px-3 py-1 bg-emerald-50 rounded-full border border-emerald-100">
            <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
            <span class="text-[9px] font-black text-emerald-700 uppercase tracking-widest">Verificado</span>
        </div>
    </nav>

    <main id="fod-container" class="pt-24 px-6 max-w-xl mx-auto opacity-0 transition-opacity duration-700">
        
        <header class="text-center mb-10">
            <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.3em] mb-3">Ficha de Origen Digital</p>
            <h1 id="fod-name" class="font-display text-4xl md:text-5xl font-extrabold text-slate-900 leading-tight mb-2">Cargando...</h1>
            <div class="flex items-center justify-center gap-2 text-slate-500 font-medium">
                <i class="fas fa-map-marker-alt text-corp-500"></i>
                <span id="fod-location">...</span>
            </div>
        </header>

        <div class="glass-card shadow-2xl shadow-slate-200 mb-10">
            <div class="relative aspect-square md:aspect-video bg-slate-100">
                <img id="fod-img" src="" class="w-full h-full object-cover">
                <div class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-black/80 to-transparent p-6 pt-20">
                    <p class="text-[10px] font-bold text-emerald-300 uppercase tracking-widest mb-1">Productor Certificado</p>
                    <p id="fod-producer" class="text-2xl font-bold text-white">...</p>
                </div>
            </div>
            <div class="p-8">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Lote</p>
                        <p id="fod-lote" class="text-lg font-bold text-slate-900">...</p>
                    </div>
                    <div class="text-right">
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Fecha Cierre</p>
                        <p id="fod-date" class="text-lg font-bold text-slate-900">...</p>
                    </div>
                </div>
                <hr class="border-slate-100 mb-6">
                <p id="fod-story" class="text-slate-600 font-light italic leading-relaxed text-lg">
                    ...
                </p>
            </div>
        </div>

        <section class="mb-12">
            <h3 class="font-display text-xl font-bold mb-8 flex items-center gap-2">
                <i class="fas fa-history text-slate-300"></i> Historia del Lote
            </h3>
            <div class="relative" id="fod-timeline">
                <div class="timeline-line"></div>
                </div>
        </section>

        <section class="glass-card bg-slate-900 text-white p-8 mb-12">
            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-6 border-b border-white/10 pb-4">Evidencia Satelital</h3>
            
            <div class="grid grid-cols-2 gap-6 mb-6">
                <div>
                    <p class="text-[10px] text-emerald-400 font-bold uppercase mb-1">Latitud</p>
                    <p id="fod-lat" class="font-mono text-sm">-33.8118</p>
                </div>
                <div>
                    <p class="text-[10px] text-emerald-400 font-bold uppercase mb-1">Longitud</p>
                    <p id="fod-lon" class="font-mono text-sm">-70.7513</p>
                </div>
            </div>

            <div class="bg-white/10 rounded-2xl p-4 text-center border border-white/10">
                <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-2">Hash de Transacción (Polygon)</p>
                <div class="font-mono text-[10px] text-emerald-300 break-all cursor-pointer hover:text-white transition-colors" onclick="window.open('https://polygonscan.com/', '_blank')">
                    0x34fe41bd7a2a34597bd098f29e2256b86ca60611 <i class="fas fa-external-link-alt ml-1"></i>
                </div>
            </div>
        </section>

        <div class="text-center">
            <a href="index.html" class="inline-block bg-white border border-slate-200 text-slate-500 px-8 py-3 rounded-full text-xs font-bold uppercase tracking-widest hover:bg-slate-50 hover:text-corp-600 transition-all">
                Verificar en AndesChain.io
            </a>
        </div>

    </main>

    <div id="loading" class="fixed inset-0 bg-white z-40 flex flex-col items-center justify-center">
        <div class="w-12 h-12 border-4 border-slate-100 border-t-corp-500 rounded-full animate-spin mb-4"></div>
        <p class="text-xs font-bold text-slate-400 uppercase tracking-widest animate-pulse">Verificando en Blockchain...</p>
    </div>

    <script>
        // 1. DATOS MOCK (Estáticos de alta calidad)
        const mockDB = {
            "GEN-001": {
                name: "Papa Desirée",
                lote: "Lote #001-A",
                producer: "Juan Pérez",
                location: "Paine Centro, Chile",
                date: "10 Feb 2026",
                img: "assets/cosecha.jpg",
                story: "Cultivada en suelo descansado por 2 años en el sector de El Vínculo. Riego tecnificado para eficiencia hídrica y cosecha manual para evitar daños mecánicos.",
                events: [
                    { title: "Siembra Certificada", date: "15 Sep 2025", desc: "Semilla libre de virus validada por SAG." },
                    { title: "Riego y Aporque", date: "20 Nov 2025", desc: "Manejo agroecológico sin pesticidas." },
                    { title: "Cosecha Final", date: "10 Feb 2026", desc: "Recolección manual. Temp: 24°C." }
                ]
            },
            "GEN-002": {
                name: "Sidra Patrimonial",
                lote: "Barrica #77",
                producer: "María González",
                location: "Huelquén, Paine",
                date: "08 Feb 2026",
                img: "https://images.unsplash.com/photo-1560249821-274878a87383?auto=format&fit=crop&q=80&w=600",
                story: "Sidra elaborada con manzanas de 5 quintas patrimoniales de Huelquén. Proceso de fermentación natural de 45 días en barricas de roble.",
                events: [
                    { title: "Recolección Manzanas", date: "15 Dic 2025", desc: "Variedades Limona y Fuji antiguas." },
                    { title: "Prensado", date: "20 Dic 2025", desc: "Extracción en frío." },
                    { title: "Embotellado", date: "08 Feb 2026", desc: "Sin filtrado excesivo." }
                ]
            },
            "GEN-003": {
                name: "Miel de Ulmo",
                lote: "Cosecha Verano",
                producer: "Coop. Los Andes",
                location: "El Vínculo",
                date: "05 Feb 2026",
                img: "https://images.unsplash.com/photo-1587049352846-4a222e784d38?auto=format&fit=crop&q=80&w=600",
                story: "Miel cruda de floración nativa de Ulmo. Cosechada respetando el ciclo de la colmena y sin procesos de pasteurización.",
                events: [
                    { title: "Floración", date: "Ene 2026", desc: "Bosque nativo precordillerano." },
                    { title: "Cosecha", date: "05 Feb 2026", desc: "Extracción en sala certificada." }
                ]
            }
        };

        // 2. FUNCIÓN PRINCIPAL
        window.onload = function() {
            // Simular carga de red (1.5s)
            setTimeout(() => {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('fod-container').classList.remove('opacity-0');
                loadProductData();
            }, 1500);
        };

        function loadProductData() {
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');

            // Intentar buscar en LocalStorage primero (Datos vivos de la demo)
            let productData = null;
            const localData = JSON.parse(localStorage.getItem('andesDB')) || [];
            
            // Buscar si el ID coincide con alguno local (o si es una prueba rápida)
            const foundLocal = localData.find(p => p.id == id);

            if (foundLocal) {
                // Formatear datos crudos de captura.html a formato FOD
                productData = {
                    name: foundLocal.productor.includes("Agricultor") ? "Cultivo Verificado" : "Producto Local",
                    lote: foundLocal.lote,
                    producer: foundLocal.productor,
                    location: "Paine (Validado por GPS)",
                    date: foundLocal.timestamp.split(' ')[0],
                    img: "https://images.unsplash.com/photo-1625246333195-78d9c38ad449?auto=format&fit=crop&q=80&w=600", // Placeholder genérico
                    story: "Este producto cuenta con registro de origen digital capturado en terreno mediante la aplicación AndesChain.",
                    events: [
                        { title: foundLocal.stage, date: foundLocal.timestamp, desc: "Evidencia fotográfica y satelital registrada." }
                    ],
                    lat: foundLocal.lat,
                    lon: foundLocal.lon
                };
            } else if (mockDB[id]) {
                // Usar Mock Data
                productData = mockDB[id];
            } else {
                // Fallback si no encuentra nada
                productData = mockDB["GEN-001"];
            }

            // Renderizar en HTML
            document.getElementById('fod-name').innerText = productData.name;
            document.getElementById('fod-producer').innerText = productData.producer;
            document.getElementById('fod-location').innerText = productData.location;
            document.getElementById('fod-lote').innerText = productData.lote;
            document.getElementById('fod-date').innerText = productData.date;
            document.getElementById('fod-img').src = productData.img;
            document.getElementById('fod-story').innerText = productData.story;
            
            // Render Lat/Lon si existen
            if(productData.lat) document.getElementById('fod-lat').innerText = productData.lat;
            if(productData.lon) document.getElementById('fod-lon').innerText = productData.lon;

            // Render Timeline
            const timelineContainer = document.getElementById('fod-timeline');
            // Limpiar timeline (dejar solo la linea)
            timelineContainer.innerHTML = '<div class="timeline-line"></div>'; 
            
            productData.events.forEach(event => {
                const item = document.createElement('div');
                item.className = "timeline-item";
                item.innerHTML = `
                    <div class="timeline-dot"></div>
                    <h4 class="font-bold text-lg text-slate-900 leading-tight">${event.title}</h4>
                    <p class="text-[10px] font-bold text-corp-500 uppercase mb-1 tracking-wider">${event.date}</p>
                    <p class="text-sm text-slate-500 font-light">${event.desc}</p>
                `;
                timelineContainer.appendChild(item);
            });
        }
    </script>
</body>
</html>
