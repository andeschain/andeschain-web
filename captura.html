<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Captura | AndesChain</title>
    <link rel="icon" type="image/png" href="assets/favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;800&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script> tailwind.config = { theme: { extend: { colors: { 'corp': { 500: '#10B981', 600: '#059669', 900: '#022C22' } }, fontFamily: { sans: ['Inter'], display: ['Outfit'] } } } } </script>
    <style> .btn-capture { background: #022C22; color: white; border-radius: 20px; padding: 18px; font-weight: 700; width: 100%; text-transform: uppercase; font-size: 14px; } </style>
</head>
<body class="bg-gray-50 pb-20">
    <nav class="sticky top-0 bg-white/90 backdrop-blur p-4 border-b flex justify-between items-center z-50">
        <div class="flex items-center gap-2"><img src="assets/favicon.png" class="h-6"><span class="font-display font-bold">AndesChain</span></div>
        <div id="gps-status" class="bg-red-100 text-red-600 px-3 py-1 rounded-full text-[10px] font-bold uppercase">Sin GPS</div>
    </nav>

    <main class="p-6 max-w-md mx-auto space-y-6">
        <div class="bg-white p-4 rounded-3xl shadow-sm border border-gray-100">
            <h2 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-3">Identidad</h2>
            <div class="flex bg-gray-100 p-1 rounded-xl mb-3">
                <button onclick="setRole('agro')" id="btn-agro" class="flex-1 py-3 rounded-lg text-xs font-bold bg-white shadow text-corp-600">AGRICULTOR</button>
                <button onclick="setRole('empre')" id="btn-empre" class="flex-1 py-3 rounded-lg text-xs font-bold text-gray-400">EMPRENDEDOR</button>
            </div>
            <input type="text" id="lote-name" placeholder="Nombre Lote/Producto" class="w-full bg-gray-50 p-3 rounded-xl text-sm font-bold outline-none border focus:border-corp-500">
            <select id="stage-select" class="w-full bg-gray-50 p-3 rounded-xl text-sm font-bold outline-none border mt-3"></select>
        </div>

        <div class="bg-white p-1 rounded-3xl border border-gray-100 shadow-sm relative group overflow-hidden">
            <div id="cam-placeholder" class="bg-gray-900 aspect-[4/5] rounded-[20px] flex flex-col items-center justify-center text-gray-500 cursor-pointer" onclick="document.getElementById('file').click()">
                <i class="fas fa-camera text-4xl text-white mb-4"></i>
                <p class="text-xs font-bold uppercase text-white">Capturar Evidencia</p>
                <input type="file" id="file" accept="image/*" capture="environment" class="hidden" onchange="handleFile(event)">
            </div>
            <img id="preview" class="hidden w-full h-full object-cover aspect-[4/5] rounded-[20px]">
            
            <div id="data-overlay" class="hidden absolute bottom-4 left-4 right-4 bg-white/90 backdrop-blur p-4 rounded-xl">
                <p class="text-[9px] font-bold text-gray-400 uppercase">Metadata Extraída</p>
                <div class="font-mono text-xs font-bold text-corp-900 mt-1"><i class="fas fa-map-pin"></i> <span id="lat"></span>, <span id="lon"></span></div>
            </div>
        </div>

        <button id="btn-submit" onclick="enviarDatos()" class="btn-capture opacity-50" disabled>Enviar a Validación</button>
    </main>

    <script src="js/simulador.js"></script>
    <script>
        let role = 'agro';
        let coords = null;
        
        const stages = {
            agro: ["Siembra", "Floración", "Cosecha"],
            empre: ["Recepción (Vínculo)", "Proceso", "Producto Final"]
        };

        window.onload = () => { initGPS(); setRole('agro'); };

        function setRole(r) {
            role = r;
            // UI Toggle logic simplificada...
            const s = document.getElementById('stage-select'); s.innerHTML = '';
            stages[r].forEach(st => { let o = document.createElement('option'); o.text = st; s.add(o); });
        }

        function initGPS() {
            navigator.geolocation.getCurrentPosition(p => {
                coords = { lat: p.coords.latitude.toFixed(4), lon: p.coords.longitude.toFixed(4) };
                document.getElementById('gps-status').className = "bg-emerald-100 text-emerald-600 px-3 py-1 rounded-full text-[10px] font-bold uppercase";
                document.getElementById('gps-status').innerText = "GPS Activo";
            });
        }

        function handleFile(e) {
            if(!coords) return alert("Falta GPS");
            const reader = new FileReader();
            reader.onload = (evt) => {
                document.getElementById('cam-placeholder').classList.add('hidden');
                document.getElementById('preview').src = evt.target.result;
                document.getElementById('preview').classList.remove('hidden');
                document.getElementById('data-overlay').classList.remove('hidden');
                document.getElementById('lat').innerText = coords.lat;
                document.getElementById('lon').innerText = coords.lon;
                document.getElementById('btn-submit').classList.remove('opacity-50');
                document.getElementById('btn-submit').disabled = false;
            };
            reader.readAsDataURL(e.target.files[0]);
        }

        function enviarDatos() {
            const data = {
                id: Date.now().toString(),
                nombre: document.getElementById('lote-name').value || "Lote Nuevo",
                lote: "Lote #" + Math.floor(Math.random()*100),
                productor: "Usuario Demo",
                tipo: role === 'agro' ? "Agricultor" : "Emprendedor",
                ubicacion: "Paine (Demo)",
                lat: coords.lat, lon: coords.lon,
                fecha: new Date().toLocaleDateString(),
                estado: "PENDING", // Pendiente de validación
                img: document.getElementById('preview').src,
                hitos: [{ titulo: document.getElementById('stage-select').value, fecha: "Hoy", desc: "Registro vía App" }]
            };
            
            // Guardar usando el simulador
            saveProducto(data);
            
            alert("✅ Datos enviados al Admin para certificación.");
            window.location.href = 'admin.html';
        }
    </script>
</body>
</html>
