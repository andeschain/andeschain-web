<script>
    let map, markers = [], geoJsonLayer, maskLayer, jsonData = null;

    window.onload = function() { initDashboard(); };

    async function initDashboard() {
        // Inicialización centrada en Chile Central
        map = L.map('map', { 
            zoomControl: false, 
            attributionControl: false 
        }).setView([-33.82, -70.75], 11);

        L.control.zoom({ position: 'bottomright' }).addTo(map);
        
        // Capa Satelital Híbrida de Google
        L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', { maxZoom: 20 }).addTo(map);
        
        try {
            const response = await fetch('https://cdn.jsdelivr.net/gh/carlosepunto/chile-geojson@master/comunas.json');
            if (!response.ok) throw new Error("No se pudo cargar el GeoJSON");
            jsonData = await response.json();
            console.log("GeoJSON cargado correctamente");
            updateTerritory("Paine"); 
        } catch (e) {
            console.error("Error inicializando datos:", e);
            // Fallback: mostrar marcadores aunque no haya polígono
            updateTerritory("Paine");
        }
    }

    function updateTerritory(comunaNombre) {
        document.getElementById('map-loader').classList.remove('hidden');
        
        // 1. Limpieza radical de capas
        if (geoJsonLayer) map.removeLayer(geoJsonLayer);
        if (maskLayer) map.removeLayer(maskLayer);
        markers.forEach(m => map.removeLayer(m));
        markers = [];

        if (jsonData) {
            // Normalizar texto para búsqueda (quitar tildes y mayúsculas)
            const norm = (str) => str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
            const comunaFeature = jsonData.features.find(f => norm(f.properties.name) === norm(comunaNombre));

            if (comunaFeature) {
                const worldOuter = [[90, -180], [90, 180], [-90, 180], [-90, -180]];
                
                // 2. Invertir coordenadas para la Máscara (Leaflet usa [Lat, Lng])
                let coordsForMask = [];
                if (comunaFeature.geometry.type === "Polygon") {
                    coordsForMask = [comunaFeature.geometry.coordinates[0].map(c => [c[1], c[0]])];
                } else if (comunaFeature.geometry.type === "MultiPolygon") {
                    coordsForMask = comunaFeature.geometry.coordinates.map(p => p[0].map(c => [c[1], c[0]]));
                }

                // Dibujar Máscara Gris
                maskLayer = L.polygon([worldOuter, ...coordsForMask], {
                    color: 'none', 
                    fillColor: '#475569', 
                    fillOpacity: 0.5, 
                    interactive: false
                }).addTo(map);

                // 3. Dibujar Borde Comunal (Verde AndesChain)
                // L.geoJSON maneja la inversión de coordenadas automáticamente
                geoJsonLayer = L.geoJSON(comunaFeature, {
                    style: { 
                        color: '#10B981', 
                        weight: 3, 
                        opacity: 1, 
                        fillColor: '#10B981', 
                        fillOpacity: 0.05, 
                        interactive: false 
                    }
                }).addTo(map);

                // 4. Forzar ajuste de vista con un pequeño timeout para asegurar renderizado
                setTimeout(() => {
                    map.invalidateSize();
                    map.fitBounds(geoJsonLayer.getBounds(), { padding: [30, 30], animate: true });
                }, 100);
            }
        }

        // 5. Filtrado de Productos del Simulador
        const rawData = window.getProductos() || [];
        const filteredData = rawData.filter(p => {
            const ubicacion = p.ubicacion.toLowerCase();
            const comuna = comunaNombre.toLowerCase();
            return ubicacion.includes(comuna);
        });
        
        document.getElementById('count-lots').innerText = filteredData.length;
        document.getElementById('count-producers').innerText = [...new Set(filteredData.map(p => p.productor))].length;

        renderList([...filteredData].reverse());
        renderMarkers(filteredData);
        
        setTimeout(() => {
            document.getElementById('map-loader').classList.add('hidden');
        }, 600);
    }

    function renderMarkers(data) {
        data.forEach(p => {
            if (!p.lat || !p.lon) return;
            const icon = L.divIcon({
                className: 'custom-pin-wrapper',
                html: `<div class="pin-pulse"></div><div class="custom-pin" style="width: 24px; height: 24px;"></div>`,
                iconSize: [24, 24], 
                iconAnchor: [12, 24], 
                popupAnchor: [0, -24]
            });
            const marker = L.marker([p.lat, p.lon], { icon: icon }).addTo(map);
            marker.bindPopup(`
                <div class="bg-white overflow-hidden">
                    <img src="${p.img}" class="w-full h-24 object-cover">
                    <div class="p-3">
                        <p class="font-bold text-xs text-corp-900">${p.nombre}</p>
                        <p class="text-[9px] text-slate-400 font-bold uppercase mb-2">${p.productor}</p>
                        <a href="producto.html?id=${p.id}" target="_blank" class="btn-expediente">Ver Expediente</a>
                    </div>
                </div>
            `);
            markers.push(marker);
        });
    }

    function renderList(data) {
        const list = document.getElementById('recent-list');
        list.innerHTML = data.length ? '' : `
            <div class="flex flex-col items-center justify-center h-full opacity-40">
                <i class="fas fa-map-marker-alt mb-2 text-2xl"></i>
                <p class="text-xs font-bold uppercase tracking-widest">Sin registros en zona</p>
            </div>`;
        
        data.forEach(p => {
            const item = document.createElement('div');
            item.className = "item-card group flex items-center gap-4 p-4 rounded-[1.2rem] bg-slate-50 cursor-pointer shadow-sm";
            item.onclick = () => { 
                map.setView([p.lat, p.lon], 16); 
                const m = markers.find(marker => {
                    const latlng = marker.getLatLng();
                    return latlng.lat == p.lat && latlng.lng == p.lon;
                });
                if(m) m.openPopup();
            };
            item.innerHTML = `
                <img src="${p.img}" class="w-12 h-12 rounded-xl object-cover shadow-sm">
                <div class="flex-1 min-w-0">
                    <p class="font-bold text-sm text-corp-900 truncate">${p.nombre}</p>
                    <p class="text-[9px] text-slate-500 font-bold uppercase">${p.productor}</p>
                </div>`;
            list.appendChild(item);
        });
    }

    function filterItems() {
        const q = document.getElementById('search-input').value.toLowerCase();
        document.querySelectorAll('.item-card').forEach(i => {
            i.style.display = i.innerText.toLowerCase().includes(q) ? 'flex' : 'none';
        });
    }
</script>
